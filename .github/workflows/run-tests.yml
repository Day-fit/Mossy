name: run-tests.yml
on:
  pull_request:
    branches: [ main ]

jobs:
  find-changed-services:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.get.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed mossy services
        id: get
        run: |
          set -euo pipefail

          # lista zmienionych plików (bez błędu, jeśli git diff nic nie zwróci)
          CHANGED="$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" || true)"

          SERVICES="$(printf "%s\n" "$CHANGED" | grep -oE '(services|self-hosted)/mossy-[^/]+' | sort -u)"

          if [ -z "$(echo "$SERVICES" | tr -d '\n')" ]; then
            echo "services=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          arr=()
          while IFS= read -r s; do
            [ -z "$s" ] && continue
            esc=$(printf '%s' "$s" | sed 's/\\/\\\\/g; s/"/\\"/g')
            arr+=("\"$esc\"")
          done <<< "$SERVICES"

          echo "services=[$(IFS=,; echo "${arr[*]}")]" >> $GITHUB_OUTPUT

  test:
    needs: find-changed-services
    if: ${{ needs.find-changed-services.outputs.services != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.find-changed-services.outputs.services) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run Maven tests
        run: |
          echo "Running tests in ${{ matrix.service }}"
          cd "${{ matrix.service }}"
          mvn -B clean test

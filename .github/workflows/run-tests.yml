name: run-tests.yml
on:
  pull_request:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      changed: ${{ steps.set-matrix.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect changed mossy services
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Diffing: $BASE_SHA..$HEAD_SHA"

          files=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || true)

          # np: self-hosted/mossy-vault/src/A.java -> ./self-hosted/mossy-vault
          services=$(echo "$files" \
            | sed -E 's#^(([^/]+/)*)?(mossy-[^/]+).*#./\1\3#' \
            | grep -E '^\./([^/]+/)*mossy-[^/]+$' \
            | sort -u || true)

          if [[ -z "${services:-}" ]]; then
            echo "No mossy-* service changes detected."
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed services:"
          echo "$services"

          json=$(echo "$services" | jq -R -s -c '
            split("\n")
            | map(select(length>0))
            | {include: map({service: .})}
          ')

          echo "matrix=$json" >> "$GITHUB_OUTPUT"
          echo "changed=true" >> "$GITHUB_OUTPUT"

  mvn-test:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Run tests
        working-directory: ${{ matrix.service }}
        run: mvn -B -ntp test